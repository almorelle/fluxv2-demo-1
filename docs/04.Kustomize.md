# Using Kustomize with flux

We've seen that to sync elements between git and the cluster, Flux was using two CRDs : `GitRepo`, and `Kustomization`.

The `Kustomization` CRD is used to do the apply of a specific path in the GitRepo; As its name suggest, it is using Kustomize to do the apply; If no `kustomization.yaml` exists at the root of the specified path, then Flux will generate one before the apply using `kustomize create --autodetect --recursive`.

What this means is you can use `kustomize` in your folders to reduce code duplication between environments.

## Example with Kubeseal
Let's do a simple installation of Kubeseal with kustomize to show you how it's done :

### Create the base
First, we'll add the helmrepository of kubeseal; since it's an element that should be shared across environments, we'll add it directly to the `base` folder :

```yaml
# cat /base/helmrepositories/sealed-secrets-helmrepository.yaml
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: sealed-secrets
  namespace: flux-system
spec:
  interval: 1h
  url: https://bitnami-labs.github.io/sealed-secrets
```

we'll also add a kustomization file in the `base/helmrepositories` pointing to the helmrepository file :
```yaml
# base/helmrepositories/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- sealed-secrets-helmrepository.yaml
```

Now, let's create the sealed-secrets application; we'll also add it to the `base` folder as it should be used on all your clusters :

```yaml
# cat /base/applications/sealed-secrets/sealed-secrets-helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: sealed-secrets
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: sealed-secrets
      version: '2.5.2'
      sourceRef:
        kind: HelmRepository
        name: sealed-secrets
        namespace: flux-system
      interval: 1m
```

```yaml
# base/applications/sealed-secrets/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- sealed-secrets-helmrelease.yaml
```

### Create the patches that will apply the base in your chosen environment

We've added the components in the base, but they are not yet created in your cluster as flux only monitors the `environments/minikube/dev` folder for now. We need to add a link to the base so that it is taken into account.

To do so, you'll need to create new `kustomization` files pointing to the one in the `base`; note that when a `kustomization` file is present in a folder, the other yaml files in it will be ignored by flux if they are not explicitely specified in the Kustomization file; so be careful when you're adding them to also add the existing resources in it.

```yaml
# cat /environments/minikube/dev/helmrepositories/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../../../base/helmrepositories
# also add here the current ressources only present on this environment
```

```yaml
# cat /environments/minikube/dev/applications/sealed-secrets/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../../../../base/applications/sealed-secrets
```

Once those files are commited, you should see the sealed-secrets server be created on your cluster.
